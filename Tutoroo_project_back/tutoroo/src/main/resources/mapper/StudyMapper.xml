<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tutoroo.mapper.StudyMapper">

    <insert id="savePlan" parameterType="com.tutoroo.entity.StudyPlanEntity" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO study_plans (user_id, goal, persona, custom_tutor_name, roadmap_json, start_date, progress_rate, status, is_paid, created_at)
        VALUES (#{userId}, #{goal}, #{persona}, #{customTutorName}, #{roadmapJson}, NOW(), #{progressRate}, #{status}, #{isPaid}, NOW())
    </insert>

    <select id="findById" resultType="com.tutoroo.entity.StudyPlanEntity">
        SELECT * FROM study_plans WHERE id = #{id}
    </select>

    <select id="findPlanById" resultType="com.tutoroo.entity.StudyPlanEntity">
        SELECT * FROM study_plans WHERE id = #{id}
    </select>

    <select id="findActivePlansByUserId" resultType="com.tutoroo.entity.StudyPlanEntity">
        SELECT * FROM study_plans
        WHERE user_id = #{userId} AND status = 'PROCEEDING'
        ORDER BY created_at DESC
    </select>

    <select id="countActivePlansByUserId" resultType="int">
        SELECT count(*) FROM study_plans
        WHERE user_id = #{userId} AND status = 'PROCEEDING'
    </select>

    <update id="updateProgress" parameterType="com.tutoroo.entity.StudyPlanEntity">
        UPDATE study_plans
        SET progress_rate = #{progressRate},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <update id="updatePlan" parameterType="com.tutoroo.entity.StudyPlanEntity">
        UPDATE study_plans
        SET goal = #{goal},
            roadmap_json = #{roadmapJson},
            custom_tutor_name = #{customTutorName},
            progress_rate = #{progressRate},
            status = #{status},
            is_paid = #{isPaid},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <insert id="saveLog" parameterType="com.tutoroo.entity.StudyLogEntity" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO study_logs (
            plan_id, study_date, day_count, content_summary, daily_summary,
            test_score, ai_feedback, student_feedback, point_change, is_completed
        ) VALUES (
                     #{planId}, NOW(), #{dayCount}, #{contentSummary}, #{dailySummary},
                     #{testScore}, #{aiFeedback}, #{studentFeedback}, #{pointChange}, #{isCompleted}
                 )
    </insert>

    <update id="updateStudentFeedback">
        UPDATE study_logs
        SET student_feedback = #{feedback}
        WHERE plan_id = #{planId} AND day_count = #{dayCount}
    </update>

    <select id="findLogsByPlanId" resultType="com.tutoroo.entity.StudyLogEntity">
        SELECT * FROM study_logs
        WHERE plan_id = #{planId}
        ORDER BY day_count ASC
    </select>

    <select id="findLogsBetweenDays" resultType="com.tutoroo.entity.StudyLogEntity">
        SELECT * FROM study_logs
        WHERE plan_id = #{planId}
          AND day_count &gt;= #{startDay}
          AND day_count &lt;= #{endDay}
        ORDER BY day_count ASC
    </select>

    <select id="findLogsByUserIdAndDate" resultType="com.tutoroo.entity.StudyLogEntity">
        SELECT l.* FROM study_logs l
                            JOIN study_plans p ON l.plan_id = p.id
        WHERE p.user_id = #{userId}
          AND DATE(l.study_date) = #{date}
    </select>

</mapper>